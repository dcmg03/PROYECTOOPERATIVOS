<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Algoritmo MLFQ</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* Colores más suaves para las colas */
        .bg-cola1 {
            background-color: #e3f2fd !important; /* Azul suave */
        }

        .bg-cola2 {
            background-color: #fff3e0 !important; /* Naranja suave */
        }

        .bg-cola3 {
            background-color: #e8f5e9 !important; /* Verde suave */
        }

        .proceso {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
        }

        .queue-card {
            border: 1px solid #dee2e6;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            background-color: #f8f9fa;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        }

        .process-badge {
            font-size: 0.9rem;
            padding: 5px 10px;
        }

        .progress-bar {
            background-color: #82b1ff !important; /* Azul para la barra de progreso */
        }

        .table th, .table td {
            text-align: center;
            vertical-align: middle;
        }

        /* Estilos para diferenciar los estados */
        .estado-ejecucion {
            background-color: #81c784 !important; /* Verde suave */
        }

        .estado-espera {
            background-color: #ffb74d !important; /* Naranja suave */
        }

        .estado-completado {
            background-color: #4db6ac !important; /* Verde agua suave */
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <h1 class="text-center mb-4">Simulador de Algoritmo MLFQ</h1>

    <!-- Queue Status -->
    <div id="estado-colas" class="row"></div>

    <!-- Completed Processes -->
    <h2 class="mt-5">Procesos Completados</h2>
    <table class="table table-striped table-hover mt-3">
        <thead class="table-dark">
        <tr>
            <th>Nombre</th>
            <th>Estado</th>
            <th>Tiempo Total</th>
        </tr>
        </thead>
        <tbody id="procesos-completados"></tbody>
    </table>

    <!-- Control Buttons -->
    <div class="text-center mt-4">
        <button id="iniciar-simulacion-btn" class="btn btn-success"><i class="fas fa-play"></i> Iniciar Simulación</button>
        <button id="pausar-simulacion-btn" class="btn btn-warning"><i class="fas fa-pause"></i> Pausar Simulación</button>
        <button id="reiniciar-simulacion-btn" class="btn btn-danger"><i class="fas fa-redo"></i> Reiniciar Simulación</button>
    </div>
</div>

<script>
    function actualizarEstadoColas() {
        $.get('/estado_procesos', function (data) {
            let colasHTML = '';
            let procesoEnEjecucion = false;  // Bandera para asegurarnos de que solo un proceso esté en ejecución

            data.colas.forEach(function (cola, index) {
                let procesosHTML = '';

                // Recorremos los procesos de cada cola
                cola.procesos.forEach(function (proceso) {
                    let progreso = ((proceso.tiempo_total - proceso.tiempo_restante) / proceso.tiempo_total) * 100;
                    let estadoColor = 'estado-espera';  // Estado por defecto para todos los procesos

                    // Aseguramos que solo un proceso esté en ejecución en la cola con mayor prioridad
                    if (proceso.estado === 'En ejecución' && !procesoEnEjecucion) {
                        estadoColor = 'estado-ejecucion';
                        procesoEnEjecucion = true;  // Solo el primer proceso en ejecución se mostrará como tal
                    } else if (proceso.estado === 'Completado') {
                        estadoColor = 'estado-completado';
                    }

                    procesosHTML += `
                        <div class="proceso ${estadoColor} p-3 mb-2 rounded">
                            <strong>${proceso.nombre}</strong><br>
                            <span class="badge process-badge bg-secondary">Tiempo Restante: ${proceso.tiempo_restante}</span><br>
                            <span class="badge process-badge ${estadoColor}">
                                Estado: ${proceso.estado}
                            </span>
                            <div class="progress mt-2">
                                <div class="progress-bar" role="progressbar" style="width: ${progreso}%;" aria-valuenow="${progreso}" aria-valuemin="0" aria-valuemax="100">${Math.round(progreso)}%</div>
                            </div>
                        </div>`;
                });

                let colaColorClass = '';
                switch (index) {
                    case 0:
                        colaColorClass = 'bg-cola1';
                        break;
                    case 1:
                        colaColorClass = 'bg-cola2';
                        break;
                    case 2:
                        colaColorClass = 'bg-cola3';
                        break;
                }

                colasHTML += `
                    <div class="col-md-4">
                        <div class="queue-card ${colaColorClass}">
                            <h3>${cola.nombre} <span class="badge bg-info">Quantum: ${cola.quantum}</span></h3>
                            ${procesosHTML || '<p class="text-muted">No hay procesos en esta cola</p>'}
                        </div>
                    </div>`;
            });

            $('#estado-colas').html(colasHTML);

            // Actualizamos la lista de procesos completados
            let completadosHTML = '';
            data.completados.forEach(function (proceso) {
                completadosHTML += `
                    <tr>
                        <td>${proceso.nombre}</td>
                        <td><span class="badge bg-success">Completado</span></td>
                        <td>${proceso.tiempo_total}</td>
                    </tr>`;
            });
            $('#procesos-completados').html(completadosHTML);
        });
    }

    // Manejadores de eventos

    let intervalId;
    $('#iniciar-simulacion-btn').click(function () {
        intervalId = setInterval(function () {
            $.get('/simular_tick', function () {
                actualizarEstadoColas();
            });
        }, 1000);
    });

    $('#pausar-simulacion-btn').click(function () {
        clearInterval(intervalId);
    });

    $('#reiniciar-simulacion-btn').click(function () {
        $.post('/reiniciar_simulacion', function (data) {
            actualizarEstadoColas();
            $('#procesos-completados').html(''); // Limpia la tabla de procesos completados
        });
    });

    // Auto-actualización de colas cada 2 segundos
    setInterval(actualizarEstadoColas, 2000);
</script>
</body>
</html>
